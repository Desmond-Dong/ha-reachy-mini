{"version":3,"file":"ha-reachy-mini-card.js","sources":["src/ha-reachy-mini-card.js"],"sourcesContent":["// Reachy Mini 3D Card - Direct Daemon Connection\r\n// Version: 3.0.0\r\n// https://github.com/Desmond-Dong/ha-reachy-mini-card\r\n\r\n/* global OrbitControls */\r\n\r\n(function () {\r\n  'use strict';\r\n\r\n  // Ë¢´Âä®ÂÖ≥ËäÇÂêçÁß∞Â∏∏Èáè\r\n  const PASSIVE_JOINT_NAMES = [\r\n    'passive_1_x', 'passive_1_y', 'passive_1_z',\r\n    'passive_2_x', 'passive_2_y', 'passive_2_z',\r\n    'passive_3_x', 'passive_3_y', 'passive_3_z',\r\n    'passive_4_x', 'passive_4_y', 'passive_4_z',\r\n    'passive_5_x', 'passive_5_y', 'passive_5_z',\r\n    'passive_6_x', 'passive_6_y', 'passive_6_z',\r\n    'passive_7_x', 'passive_7_y', 'passive_7_z',\r\n  ];\r\n\r\n  // ÈÖçÁΩÆÁºñËæëÂô® - ÂøÖÈ°ªÂú®‰∏ªÂç°‰πãÂâçÂÆö‰πâÂíåÊ≥®ÂÜå\r\n  class ReachyMini3DCardEditor extends HTMLElement {\r\n    constructor() {\r\n      super();\r\n      this.attachShadow({ mode: 'open' });\r\n    }\r\n\r\n    setConfig(config) {\r\n      this._config = config;\r\n      this.render();\r\n    }\r\n\r\n    render() {\r\n      const config = this._config || {};\r\n\r\n      this.shadowRoot.innerHTML = `\r\n      <style>\r\n        :host { display: block; }\r\n        .form-row {\r\n          display: flex;\r\n          flex-direction: column;\r\n          margin-bottom: 12px;\r\n        }\r\n        label {\r\n          font-size: 14px;\r\n          font-weight: 500;\r\n          margin-bottom: 4px;\r\n          color: var(--primary-text-color);\r\n        }\r\n        input[type=\"text\"],\r\n        input[type=\"number\"] {\r\n          width: 100%;\r\n          padding: 8px;\r\n          border: 1px solid var(--primary-color);\r\n          border-radius: 4px;\r\n          background: var(--card-background-color);\r\n          color: var(--primary-text-color);\r\n          box-sizing: border-box;\r\n        }\r\n        input[type=\"text\"]:focus,\r\n        input[type=\"number\"]:focus {\r\n          outline: none;\r\n          border-color: var(--accent-color);\r\n        }\r\n        .checkbox-row {\r\n          display: flex;\r\n          align-items: center;\r\n          gap: 8px;\r\n          margin-bottom: 8px;\r\n        }\r\n        .checkbox-row input[type=\"checkbox\"] {\r\n          width: auto;\r\n          margin: 0;\r\n        }\r\n        .checkbox-row label {\r\n          margin-bottom: 0;\r\n          flex: 1;\r\n        }\r\n        .hint {\r\n          font-size: 12px;\r\n          color: var(--secondary-text-color);\r\n          margin-top: 4px;\r\n        }\r\n        .section-title {\r\n          font-size: 13px;\r\n          font-weight: 600;\r\n          color: var(--primary-text-color);\r\n          margin-top: 16px;\r\n          margin-bottom: 8px;\r\n          text-transform: uppercase;\r\n          letter-spacing: 0.5px;\r\n        }\r\n      </style>\r\n\r\n      <div class=\"section-title\">Connection</div>\r\n\r\n      <div class=\"form-row\">\r\n        <label for=\"host\">Daemon Host</label>\r\n        <input\r\n          id=\"host\"\r\n          type=\"text\"\r\n          value=\"${config.daemon_host || 'localhost'}\"\r\n          placeholder=\"localhost or IP address\"\r\n        />\r\n        <div class=\"hint\">Reachy Mini daemon hostname or IP address</div>\r\n      </div>\r\n\r\n      <div class=\"form-row\">\r\n        <label for=\"port\">Daemon Port</label>\r\n        <input\r\n          id=\"port\"\r\n          type=\"number\"\r\n          value=\"${config.daemon_port || 8000}\"\r\n          placeholder=\"8000\"\r\n        />\r\n        <div class=\"hint\">WebSocket port (default: 8000)</div>\r\n      </div>\r\n\r\n      <div class=\"section-title\">Display</div>\r\n\r\n      <div class=\"form-row\">\r\n        <label for=\"height\">Card Height (px)</label>\r\n        <input\r\n          id=\"height\"\r\n          type=\"number\"\r\n          value=\"${config.height || 400}\"\r\n          placeholder=\"400\"\r\n        />\r\n        <div class=\"hint\">Height of the card in pixels</div>\r\n      </div>\r\n\r\n      <div class=\"form-row\">\r\n        <label for=\"background\">Background Color</label>\r\n        <input\r\n          id=\"background\"\r\n          type=\"text\"\r\n          value=\"${config.background_color || '#f5f5f5'}\"\r\n          placeholder=\"#f5f5f5\"\r\n        />\r\n        <div class=\"hint\">Background color (hex code)</div>\r\n      </div>\r\n\r\n      <div class=\"form-row\">\r\n        <label for=\"camera_distance\">Camera Distance</label>\r\n        <input\r\n          id=\"camera_distance\"\r\n          type=\"number\"\r\n          step=\"0.1\"\r\n          value=\"${config.camera_distance || 0.5}\"\r\n          placeholder=\"0.5\"\r\n        />\r\n        <div class=\"hint\">Initial camera distance (0.2 - 1.5)</div>\r\n      </div>\r\n\r\n      <div class=\"section-title\">Features</div>\r\n\r\n      <div class=\"checkbox-row\">\r\n        <input type=\"checkbox\" id=\"enable_passive\" ${config.enable_passive_joints !== false ? 'checked' : ''}>\r\n        <label for=\"enable_passive\">Enable Passive Joints</label>\r\n      </div>\r\n      <div class=\"hint\">Show Stewart platform passive joints (requires daemon support)</div>\r\n\r\n      <div class=\"checkbox-row\">\r\n        <input type=\"checkbox\" id=\"enable_pose\" ${config.enable_head_pose !== false ? 'checked' : ''}>\r\n        <label for=\"enable_pose\">Enable Head Pose</label>\r\n      </div>\r\n      <div class=\"hint\">Use 4x4 pose matrix for head positioning</div>\r\n\r\n      <div class=\"checkbox-row\">\r\n        <input type=\"checkbox\" id=\"enable_grid\" ${config.enable_grid !== false ? 'checked' : ''}>\r\n        <label for=\"enable_grid\">Show Grid</label>\r\n      </div>\r\n      <div class=\"hint\">Display ground grid helper</div>\r\n    `;\r\n\r\n      // ÁõëÂê¨ËæìÂÖ•ÂèòÂåñ\r\n      this.shadowRoot.getElementById('host').addEventListener('change', (e) => {\r\n        this._config = { ...this._config, daemon_host: e.target.value };\r\n        this.dispatchConfig();\r\n      });\r\n\r\n      this.shadowRoot.getElementById('port').addEventListener('change', (e) => {\r\n        this._config = { ...this._config, daemon_port: parseInt(e.target.value) };\r\n        this.dispatchConfig();\r\n      });\r\n\r\n      this.shadowRoot.getElementById('height').addEventListener('change', (e) => {\r\n        this._config = { ...this._config, height: parseInt(e.target.value) };\r\n        this.dispatchConfig();\r\n      });\r\n\r\n      this.shadowRoot.getElementById('background').addEventListener('change', (e) => {\r\n        this._config = { ...this._config, background_color: e.target.value };\r\n        this.dispatchConfig();\r\n      });\r\n\r\n      this.shadowRoot.getElementById('camera_distance').addEventListener('change', (e) => {\r\n        this._config = { ...this._config, camera_distance: parseFloat(e.target.value) };\r\n        this.dispatchConfig();\r\n      });\r\n\r\n      this.shadowRoot.getElementById('enable_passive').addEventListener('change', (e) => {\r\n        this._config = { ...this._config, enable_passive_joints: e.target.checked };\r\n        this.dispatchConfig();\r\n      });\r\n\r\n      this.shadowRoot.getElementById('enable_pose').addEventListener('change', (e) => {\r\n        this._config = { ...this._config, enable_head_pose: e.target.checked };\r\n        this.dispatchConfig();\r\n      });\r\n\r\n      this.shadowRoot.getElementById('enable_grid').addEventListener('change', (e) => {\r\n        this._config = { ...this._config, enable_grid: e.target.checked };\r\n        this.dispatchConfig();\r\n      });\r\n    }\r\n\r\n    dispatchConfig() {\r\n      const event = new CustomEvent('config-changed', {\r\n        detail: { config: this._config },\r\n        bubbles: true,\r\n        composed: true\r\n      });\r\n      this.dispatchEvent(event);\r\n    }\r\n  }\r\n\r\n  // Ê≥®ÂÜåÁºñËæëÂô®\r\n  customElements.define('ha-reachy-mini-card-editor', ReachyMini3DCardEditor);\r\n\r\n  // ‰∏ªÂç°ÁâáÁªÑ‰ª∂\r\n  class ReachyMini3DCard extends HTMLElement {\r\n    constructor() {\r\n      super();\r\n      this.attachShadow({ mode: 'open' });\r\n      this._frameCount = 0;\r\n      this._lastDataVersion = -1;\r\n      this._robotState = {\r\n        headJoints: null,\r\n        headPose: null,\r\n        passiveJoints: null,\r\n        antennas: [0, 0],\r\n        dataVersion: 0\r\n      };\r\n      this._reconnectAttempts = 0;\r\n      this._maxReconnectAttempts = 10;\r\n      this._reconnectDelay = 3000;\r\n      this._reconnectTimeout = null;\r\n    }\r\n\r\n    static getConfigElement() {\r\n      return document.createElement('ha-reachy-mini-card-editor');\r\n    }\r\n\r\n    static getStubConfig() {\r\n      return {\r\n        daemon_host: 'localhost',\r\n        daemon_port: 8000,\r\n        height: 400,\r\n        enable_passive_joints: true,\r\n        enable_head_pose: true,\r\n        background_color: '#f5f5f5',\r\n        enable_grid: true,\r\n        camera_distance: 0.5\r\n      };\r\n    }\r\n\r\n    setConfig(config) {\r\n      this._config = {\r\n        daemon_host: 'localhost',\r\n        daemon_port: 8000,\r\n        height: 400,\r\n        enable_passive_joints: true,\r\n        enable_head_pose: true,\r\n        background_color: '#f5f5f5',\r\n        enable_grid: true,\r\n        camera_distance: 0.5,\r\n        ...config\r\n      };\r\n    }\r\n\r\n    getCardSize() {\r\n      return this._config.height ? this._config.height / 50 : 8;\r\n    }\r\n\r\n    getGridOptions() {\r\n      // Grid options for sections view (12 columns grid)\r\n      const height = this._config.height || 400;\r\n      const rows = Math.ceil(height / 50);\r\n      return {\r\n        rows: rows,\r\n        columns: 6,\r\n        min_rows: 4,\r\n        max_rows: 20,\r\n      };\r\n    }\r\n\r\n    set hass(hass) {\r\n      // Store Home Assistant instance (required by custom card API)\r\n      this._hass = hass;\r\n      // This card doesn't use HA entities directly, but set hass is required\r\n    }\r\n\r\n    async connectedCallback() {\r\n      this.render();\r\n      await this.init();\r\n    }\r\n\r\n    render() {\r\n      this.shadowRoot.innerHTML = `\r\n      <style>\r\n        :host { display: block; }\r\n        ha-card {\r\n          overflow: hidden;\r\n          border-radius: var(--ha-card-border-radius, 12px);\r\n          box-shadow: var(--ha-card-box-shadow, none);\r\n        }\r\n        #container {\r\n          position: relative;\r\n          width: 100%;\r\n          height: ${this._config.height}px;\r\n        }\r\n        #status {\r\n          position: absolute;\r\n          top: 10px;\r\n          left: 10px;\r\n          padding: 6px 12px;\r\n          border-radius: 20px;\r\n          font-size: 12px;\r\n          font-weight: 500;\r\n          color: white;\r\n          z-index: 10;\r\n          transition: all 0.3s ease;\r\n        }\r\n        .connected { background: #4caf50; }\r\n        .connecting { background: #ff9800; }\r\n        .error { background: #f44336; }\r\n        .loading {\r\n          position: absolute;\r\n          top: 50%;\r\n          left: 50%;\r\n          transform: translate(-50%, -50%);\r\n        }\r\n        #fps-counter {\r\n          position: absolute;\r\n          top: 10px;\r\n          right: 10px;\r\n          padding: 4px 8px;\r\n          border-radius: 12px;\r\n          font-size: 11px;\r\n          font-weight: 500;\r\n          color: white;\r\n          background: rgba(0, 0, 0, 0.6);\r\n          z-index: 10;\r\n        }\r\n      </style>\r\n      <ha-card>\r\n        <div id=\"container\">\r\n          <div id=\"status\" class=\"connecting\">Connecting...</div>\r\n          <div id=\"fps-counter\">0 FPS</div>\r\n          <div id=\"loading\" class=\"loading\">\r\n            <ha-circular-progress indeterminate></ha-circular-progress>\r\n          </div>\r\n        </div>\r\n      </ha-card>\r\n    `;\r\n    }\r\n\r\n    async init() {\r\n      try {\r\n        await this.loadThreeJS();\r\n        await this.startPolling();\r\n        await this.loadRobot();\r\n      } catch (err) {\r\n        console.error('Init error:', err);\r\n        this.showError(err.message);\r\n      }\r\n    }\r\n\r\n    async loadThreeJS() {\r\n      const basePath = this.getBasePath();\r\n      \r\n      // Check if already loaded\r\n      if (typeof THREE !== 'undefined' && THREE) {\r\n        console.log('‚úÖ Three.js already loaded');\r\n        return;\r\n      }\r\n\r\n      console.log('üì¶ Loading Three.js from lib/three.core.js...');\r\n      \r\n      try {\r\n        // Use dynamic import to load Three.js as a module\r\n        const threeModule = await import(`${basePath}lib/three.core.js`);\r\n        \r\n        // Create global THREE object with all exports\r\n        window.THREE = threeModule;\r\n        \r\n        console.log('‚úÖ Three.js loaded');\r\n        \r\n        // Load OrbitControls using dynamic import\r\n        const orbitControlsModule = await import(`${basePath}lib/OrbitControls.js`);\r\n        \r\n        // Add OrbitControls to global for linter\r\n        window.OrbitControls = orbitControlsModule.OrbitControls || orbitControlsModule.default;\r\n        \r\n        console.log('‚úÖ OrbitControls loaded');\r\n      } catch (error) {\r\n        console.error('‚ùå Failed to load Three.js:', error);\r\n        throw new Error('Failed to load Three.js: ' + error.message);\r\n      }\r\n    }\r\n\r\n    async startPolling() {\r\n      const { daemon_host, daemon_port } = this._config;\r\n      const apiUrl = `http://${daemon_host}:${daemon_port}/api/state/full?with_control_mode=true&with_head_joints=true&with_body_yaw=true&with_antenna_positions=true`;\r\n      \r\n      console.log('üîÑ Starting polling:', apiUrl);\r\n      \r\n      this._pollingInterval = setInterval(async () => {\r\n        try {\r\n          const response = await fetch(apiUrl);\r\n          if (response.ok) {\r\n            const data = await response.json();\r\n            this._processRobotData(data);\r\n            this.updateStatus('connected', 'Connected');\r\n          } else {\r\n            console.error('‚ùå API error:', response.status);\r\n            this.updateStatus('error', `Error: ${response.status}`);\r\n          }\r\n        } catch (err) {\r\n          console.error('‚ùå Polling error:', err);\r\n          this.updateStatus('error', 'Connection Failed');\r\n        }\r\n      }, 500); // Poll every 500ms like reference project\r\n    }\r\n\r\n    _processRobotData(data) {\r\n      // head_joints: Array of 7 values [yaw_body, stewart_1, ..., stewart_6]\r\n      if (data.head_joints && Array.isArray(data.head_joints) && data.head_joints.length >= 7) {\r\n        this._robotState.headJoints = data.head_joints;\r\n      }\r\n      \r\n      // body_yaw: Single value (same as head_joints[0])\r\n      if (data.body_yaw !== undefined) {\r\n        if (!this._robotState.headJoints) {\r\n          this._robotState.headJoints = [];\r\n        }\r\n        this._robotState.headJoints[0] = data.body_yaw;\r\n      }\r\n      \r\n      // head_pose: Object with x, y, z, roll, pitch, yaw\r\n      if (data.head_pose) {\r\n        this._robotState.headPose = data.head_pose;\r\n      }\r\n      \r\n      // antennas_position: Array of 2 values [left, right]\r\n      if (data.antennas_position && Array.isArray(data.antennas_position) && data.antennas_position.length >= 2) {\r\n        this._robotState.antennas = data.antennas_position;\r\n      }\r\n      \r\n      // passive_joints: Array of 21 values or null\r\n      if (data.passive_joints && Array.isArray(data.passive_joints) && data.passive_joints.length >= 21) {\r\n        this._robotState.passiveJoints = data.passive_joints;\r\n      }\r\n      \r\n      this._robotState.dataVersion++;\r\n      this._updateRobot();\r\n    }\r\n\r\n    _updateRobot() {\r\n      if (!this._robot) return;\r\n      \r\n      this._frameCount++;\r\n      if (this._frameCount % 3 !== 0) {\r\n        return; // Throttle to ~20Hz\r\n      }\r\n      \r\n      if (this._robotState.dataVersion === this._lastDataVersion) {\r\n        return; // No new data\r\n      }\r\n      this._lastDataVersion = this._robotState.dataVersion;\r\n\r\n      // Apply head joints\r\n      if (this._robotState.headJoints) {\r\n        const joints = this._robotState.headJoints;\r\n        if (this._robot.joints['yaw_body']) {\r\n          this._robot.setJointValue('yaw_body', joints[0]);\r\n        }\r\n        ['stewart_1', 'stewart_2', 'stewart_3', 'stewart_4', 'stewart_5', 'stewart_6'].forEach((name, i) => {\r\n          if (this._robot.joints[name]) {\r\n            this._robot.setJointValue(name, joints[i + 1]);\r\n          }\r\n        });\r\n      }\r\n\r\n      // Apply head pose if enabled (x, y, z, roll, pitch, yaw)\r\n      if (this._config.enable_head_pose !== false && this._robotState.headPose) {\r\n        const pose = this._robotState.headPose;\r\n        // Note: head_pose is for visualization, actual joint movement is controlled by head_joints\r\n        // The head_joints already include the yaw (yaw_body) and stewart platform positions\r\n      }\r\n\r\n      // Apply passive joints\r\n      if (this._config.enable_passive_joints !== false && this._robotState.passiveJoints) {\r\n        const passiveJoints = this._robotState.passiveJoints;\r\n        for (let i = 0; i < 21; i++) {\r\n          const jointName = PASSIVE_JOINT_NAMES[i];\r\n          if (this._robot.joints[jointName]) {\r\n            this._robot.setJointValue(jointName, passiveJoints[i]);\r\n          }\r\n        }\r\n      }\r\n\r\n      // Apply antennas\r\n      if (this._robotState.antennas) {\r\n        const antennas = this._robotState.antennas;\r\n        if (this._robot.joints['left_antenna']) {\r\n          this._robot.setJointValue('left_antenna', -antennas[1]);\r\n        }\r\n        if (this._robot.joints['right_antenna']) {\r\n          this._robot.setJointValue('right_antenna', -antennas[0]);\r\n        }\r\n      }\r\n    }\r\n\r\n    async loadRobot() {\r\n      const basePath = this.getBasePath();\r\n      \r\n      // Âä®ÊÄÅÂä†ËΩΩ URDFLoader Áõ∏ÂÖ≥Ê®°Âùó\r\n      await import(`${basePath}lib/URDFClasses.js`);\r\n      await import(`${basePath}lib/URDFDragControls.js`);\r\n      \r\n      const URDFLoaderModule = await import(`${basePath}lib/urdf-loader.js`);\r\n      const URDFLoader = URDFLoaderModule.default;\r\n      \r\n      const loader = new URDFLoader();\r\n      loader.workingPath = `${basePath}assets/`;\r\n      \r\n      this._robot = await loader.load(`${basePath}assets/reachy-mini.urdf`);\r\n      this._scene.add(this._robot);\r\n\r\n      // Initialize all joints to zero\r\n      this._initializeJoints();\r\n\r\n      // Hide loading\r\n      const loading = this.shadowRoot.querySelector('#loading');\r\n      if (loading) loading.style.display = 'none';\r\n\r\n      // Start animation loop\r\n      this._startAnimation();\r\n    }\r\n\r\n    _initializeJoints() {\r\n      if (!this._robot || !this._robot.joints) return;\r\n\r\n      // Initialize yaw_body\r\n      if (this._robot.joints['yaw_body']) {\r\n        this._robot.setJointValue('yaw_body', 0);\r\n      }\r\n\r\n      // Initialize stewart joints\r\n      ['stewart_1', 'stewart_2', 'stewart_3', 'stewart_4', 'stewart_5', 'stewart_6'].forEach(jointName => {\r\n        if (this._robot.joints[jointName]) {\r\n          this._robot.setJointValue(jointName, 0);\r\n        }\r\n      });\r\n\r\n      // Initialize passive joints\r\n      PASSIVE_JOINT_NAMES.forEach(jointName => {\r\n        if (this._robot.joints[jointName]) {\r\n          this._robot.setJointValue(jointName, 0);\r\n        }\r\n      });\r\n\r\n      // Initialize antennas\r\n      ['left_antenna', 'right_antenna'].forEach(jointName => {\r\n        if (this._robot.joints[jointName]) {\r\n          this._robot.setJointValue(jointName, 0);\r\n        }\r\n      });\r\n    }\r\n\r\n    _startAnimation() {\r\n      const container = this.shadowRoot.querySelector('#container');\r\n      const canvas = document.createElement('canvas');\r\n      container.appendChild(canvas);\r\n      \r\n      // Scene\r\n      this._scene = new THREE.Scene();\r\n      this._scene.background = new THREE.Color(this._config.background_color || '#f5f5f5');\r\n\r\n      // Camera\r\n      this._camera = new THREE.PerspectiveCamera(\r\n        50,\r\n        container.clientWidth / this._config.height,\r\n        0.01,\r\n        1000\r\n      );\r\n      this._camera.position.set(0.3, 0.3, this._config.camera_distance || 0.5);\r\n\r\n      // Renderer\r\n      this._renderer = new THREE.WebGLRenderer({ canvas, antialias: true });\r\n      this._renderer.setSize(container.clientWidth, this._config.height);\r\n      this._renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));\r\n\r\n      // Controls\r\n      this._controls = new OrbitControls(this._camera, canvas);\r\n      this._controls.enableDamping = true;\r\n      this._controls.dampingFactor = 0.05;\r\n      this._controls.minDistance = 0.2;\r\n      this._controls.maxDistance = 1.5;\r\n\r\n      // Lights\r\n      this._scene.add(new THREE.AmbientLight(0xffffff, 0.6));\r\n      \r\n      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);\r\n      directionalLight.position.set(1, 1, 1);\r\n      this._scene.add(directionalLight);\r\n      \r\n      const backLight = new THREE.DirectionalLight(0xffffff, 0.3);\r\n      backLight.position.set(-1, -1, -1);\r\n      this._scene.add(backLight);\r\n\r\n      // Grid\r\n      if (this._config.enable_grid !== false) {\r\n        this._scene.add(new THREE.GridHelper(0.4, 20, 0x888888, 0xcccccc));\r\n      }\r\n\r\n      // FPS counter\r\n      this._fpsCounter = {\r\n        frameCount: 0,\r\n        lastTime: performance.now(),\r\n        fps: 0\r\n      };\r\n\r\n      // Animation loop\r\n      const animate = () => {\r\n        requestAnimationFrame(animate);\r\n        \r\n        // FPS calculation\r\n        this._fpsCounter.frameCount++;\r\n        const currentTime = performance.now();\r\n        if (currentTime - this._fpsCounter.lastTime >= 1000) {\r\n          this._fpsCounter.fps = this._fpsCounter.frameCount;\r\n          this._fpsCounter.frameCount = 0;\r\n          this._fpsCounter.lastTime = currentTime;\r\n          \r\n          const fpsEl = this.shadowRoot.querySelector('#fps-counter');\r\n          if (fpsEl) {\r\n            fpsEl.textContent = `${this._fpsCounter.fps} FPS`;\r\n          }\r\n        }\r\n        \r\n        this._controls.update();\r\n        this._renderer.render(this._scene, this._camera);\r\n      };\r\n      animate();\r\n    }\r\n\r\n    updateStatus(status, message) {\r\n      const statusEl = this.shadowRoot.querySelector('#status');\r\n      if (statusEl) {\r\n        statusEl.className = status;\r\n        statusEl.textContent = message;\r\n      }\r\n    }\r\n\r\n    showError(message) {\r\n      const container = this.shadowRoot.querySelector('#container');\r\n      if (container) {\r\n        container.innerHTML = `\r\n          <div style=\"padding: 20px; color: #f44336;\">Error: ${message}</div>\r\n        `;\r\n      }\r\n    }\r\n\r\n    getBasePath() {\r\n      return '/hacsfiles/ha-reachy-mini-card/';\r\n    }\r\n\r\ndisconnectedCallback() {\r\n      if (this._pollingInterval) {\r\n        clearInterval(this._pollingInterval);\r\n        this._pollingInterval = null;\r\n      }\r\n      if (this._renderer) {\r\n        this._renderer.dispose();\r\n        this._renderer = null;\r\n      }\r\n      if (this._scene) {\r\n        this._scene.clear();\r\n        this._scene = null;\r\n      }\r\n    }\r\n  }\r\n\r\n  // Ê≥®ÂÜå‰∏ªÂç°Áâá\r\n  customElements.define('ha-reachy-mini-card', ReachyMini3DCard);\r\n\r\n  // Ê≥®ÂÜåÂà∞ window.customCards ‰ª•‰æøÂú®Âç°ÁâáÈÄâÊã©Âô®‰∏≠ÊòæÁ§∫\r\n  window.customCards = window.customCards || [];\r\n  window.customCards.push({\r\n    type: 'ha-reachy-mini-card',\r\n    name: 'Reachy Mini 3D Card',\r\n    description: '3D visualization of Reachy Mini robot',\r\n    preview: true,\r\n    documentationURL: 'https://github.com/Desmond-Dong/ha-reachy-mini-card',\r\n  });\r\n\r\n})();"],"names":["PASSIVE_JOINT_NAMES","ReachyMini3DCardEditor","HTMLElement","constructor","super","this","attachShadow","mode","setConfig","config","_config","render","shadowRoot","innerHTML","daemon_host","daemon_port","height","background_color","camera_distance","enable_passive_joints","enable_head_pose","enable_grid","getElementById","addEventListener","e","target","value","dispatchConfig","parseInt","parseFloat","checked","event","CustomEvent","detail","bubbles","composed","dispatchEvent","customElements","define","ReachyMini3DCard","_frameCount","_lastDataVersion","_robotState","headJoints","headPose","passiveJoints","antennas","dataVersion","_reconnectAttempts","_maxReconnectAttempts","_reconnectDelay","_reconnectTimeout","getConfigElement","document","createElement","getStubConfig","getCardSize","getGridOptions","rows","Math","ceil","columns","min_rows","max_rows","hass","_hass","connectedCallback","init","loadThreeJS","startPolling","loadRobot","err","console","error","showError","message","basePath","getBasePath","THREE","log","threeModule","import","window","orbitControlsModule","OrbitControls","default","Error","apiUrl","_pollingInterval","setInterval","async","response","fetch","ok","data","json","_processRobotData","updateStatus","status","head_joints","Array","isArray","length","undefined","body_yaw","head_pose","antennas_position","passive_joints","_updateRobot","_robot","joints","setJointValue","forEach","name","i","jointName","loader","URDFLoader","workingPath","load","_scene","add","_initializeJoints","loading","querySelector","style","display","_startAnimation","container","canvas","appendChild","Scene","background","Color","_camera","PerspectiveCamera","clientWidth","position","set","_renderer","WebGLRenderer","antialias","setSize","setPixelRatio","min","devicePixelRatio","_controls","enableDamping","dampingFactor","minDistance","maxDistance","AmbientLight","directionalLight","DirectionalLight","backLight","GridHelper","_fpsCounter","frameCount","lastTime","performance","now","fps","animate","requestAnimationFrame","currentTime","fpsEl","textContent","update","statusEl","className","disconnectedCallback","clearInterval","dispose","clear","customCards","push","type","description","preview","documentationURL"],"mappings":"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"}