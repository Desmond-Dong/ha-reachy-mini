!function(){"use strict";!function(){const e=["passive_1_x","passive_1_y","passive_1_z","passive_2_x","passive_2_y","passive_2_z","passive_3_x","passive_3_y","passive_3_z","passive_4_x","passive_4_y","passive_4_z","passive_5_x","passive_5_y","passive_5_z","passive_6_x","passive_6_y","passive_6_z","passive_7_x","passive_7_y","passive_7_z"];class t extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"})}setConfig(e){this._config=e,this.render()}render(){const e=this._config||{};this.shadowRoot.innerHTML=`\n      <style>\n        :host { display: block; }\n        .form-row {\n          display: flex;\n          flex-direction: column;\n          margin-bottom: 12px;\n        }\n        label {\n          font-size: 14px;\n          font-weight: 500;\n          margin-bottom: 4px;\n          color: var(--primary-text-color);\n        }\n        input[type="text"],\n        input[type="number"] {\n          width: 100%;\n          padding: 8px;\n          border: 1px solid var(--primary-color);\n          border-radius: 4px;\n          background: var(--card-background-color);\n          color: var(--primary-text-color);\n          box-sizing: border-box;\n        }\n        input[type="text"]:focus,\n        input[type="number"]:focus {\n          outline: none;\n          border-color: var(--accent-color);\n        }\n        .checkbox-row {\n          display: flex;\n          align-items: center;\n          gap: 8px;\n          margin-bottom: 8px;\n        }\n        .checkbox-row input[type="checkbox"] {\n          width: auto;\n          margin: 0;\n        }\n        .checkbox-row label {\n          margin-bottom: 0;\n          flex: 1;\n        }\n        .hint {\n          font-size: 12px;\n          color: var(--secondary-text-color);\n          margin-top: 4px;\n        }\n        .section-title {\n          font-size: 13px;\n          font-weight: 600;\n          color: var(--primary-text-color);\n          margin-top: 16px;\n          margin-bottom: 8px;\n          text-transform: uppercase;\n          letter-spacing: 0.5px;\n        }\n      </style>\n\n      <div class="section-title">Connection</div>\n\n      <div class="form-row">\n        <label for="host">Daemon Host</label>\n        <input\n          id="host"\n          type="text"\n          value="${e.daemon_host||"localhost"}"\n          placeholder="localhost or IP address"\n        />\n        <div class="hint">Reachy Mini daemon hostname or IP address</div>\n      </div>\n\n      <div class="form-row">\n        <label for="port">Daemon Port</label>\n        <input\n          id="port"\n          type="number"\n          value="${e.daemon_port||8e3}"\n          placeholder="8000"\n        />\n        <div class="hint">WebSocket port (default: 8000)</div>\n      </div>\n\n      <div class="section-title">Display</div>\n\n      <div class="form-row">\n        <label for="height">Card Height (px)</label>\n        <input\n          id="height"\n          type="number"\n          value="${e.height||400}"\n          placeholder="400"\n        />\n        <div class="hint">Height of the card in pixels</div>\n      </div>\n\n      <div class="form-row">\n        <label for="background">Background Color</label>\n        <input\n          id="background"\n          type="text"\n          value="${e.background_color||"#f5f5f5"}"\n          placeholder="#f5f5f5"\n        />\n        <div class="hint">Background color (hex code)</div>\n      </div>\n\n      <div class="form-row">\n        <label for="camera_distance">Camera Distance</label>\n        <input\n          id="camera_distance"\n          type="number"\n          step="0.1"\n          value="${e.camera_distance||.5}"\n          placeholder="0.5"\n        />\n        <div class="hint">Initial camera distance (0.2 - 1.5)</div>\n      </div>\n\n      <div class="section-title">Features</div>\n\n      <div class="checkbox-row">\n        <input type="checkbox" id="enable_passive" ${!1!==e.enable_passive_joints?"checked":""}>\n        <label for="enable_passive">Enable Passive Joints</label>\n      </div>\n      <div class="hint">Show Stewart platform passive joints (requires daemon support)</div>\n\n      <div class="checkbox-row">\n        <input type="checkbox" id="enable_pose" ${!1!==e.enable_head_pose?"checked":""}>\n        <label for="enable_pose">Enable Head Pose</label>\n      </div>\n      <div class="hint">Use 4x4 pose matrix for head positioning</div>\n\n      <div class="checkbox-row">\n        <input type="checkbox" id="enable_grid" ${!1!==e.enable_grid?"checked":""}>\n        <label for="enable_grid">Show Grid</label>\n      </div>\n      <div class="hint">Display ground grid helper</div>\n    `,this.shadowRoot.getElementById("host").addEventListener("change",e=>{this._config={...this._config,daemon_host:e.target.value},this.dispatchConfig()}),this.shadowRoot.getElementById("port").addEventListener("change",e=>{this._config={...this._config,daemon_port:parseInt(e.target.value)},this.dispatchConfig()}),this.shadowRoot.getElementById("height").addEventListener("change",e=>{this._config={...this._config,height:parseInt(e.target.value)},this.dispatchConfig()}),this.shadowRoot.getElementById("background").addEventListener("change",e=>{this._config={...this._config,background_color:e.target.value},this.dispatchConfig()}),this.shadowRoot.getElementById("camera_distance").addEventListener("change",e=>{this._config={...this._config,camera_distance:parseFloat(e.target.value)},this.dispatchConfig()}),this.shadowRoot.getElementById("enable_passive").addEventListener("change",e=>{this._config={...this._config,enable_passive_joints:e.target.checked},this.dispatchConfig()}),this.shadowRoot.getElementById("enable_pose").addEventListener("change",e=>{this._config={...this._config,enable_head_pose:e.target.checked},this.dispatchConfig()}),this.shadowRoot.getElementById("enable_grid").addEventListener("change",e=>{this._config={...this._config,enable_grid:e.target.checked},this.dispatchConfig()})}dispatchConfig(){const e=new CustomEvent("config-changed",{detail:{config:this._config},bubbles:!0,composed:!0});this.dispatchEvent(e)}}customElements.define("ha-reachy-mini-card-editor",t);class n extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"}),this._frameCount=0,this._lastDataVersion=-1,this._robotState={headJoints:null,headPose:null,passiveJoints:null,antennas:[0,0],dataVersion:0},this._reconnectAttempts=0,this._maxReconnectAttempts=10,this._reconnectDelay=3e3,this._reconnectTimeout=null}static get getConfigElement(){return document.createElement("ha-reachy-mini-card-editor")}static getStubConfig(){return{daemon_host:"localhost",daemon_port:8e3,height:400,enable_passive_joints:!0,enable_head_pose:!0,background_color:"#f5f5f5",enable_grid:!0,camera_distance:.5}}setConfig(e){this._config={daemon_host:"localhost",daemon_port:8e3,height:400,enable_passive_joints:!0,enable_head_pose:!0,background_color:"#f5f5f5",enable_grid:!0,camera_distance:.5,...e}}getCardSize(){return this._config.height?this._config.height/50:8}async connectedCallback(){this.render(),await this.init()}render(){this.shadowRoot.innerHTML=`\n      <style>\n        :host { display: block; }\n        ha-card {\n          overflow: hidden;\n          border-radius: var(--ha-card-border-radius, 12px);\n          box-shadow: var(--ha-card-box-shadow, none);\n        }\n        #container {\n          position: relative;\n          width: 100%;\n          height: ${this._config.height}px;\n        }\n        #status {\n          position: absolute;\n          top: 10px;\n          left: 10px;\n          padding: 6px 12px;\n          border-radius: 20px;\n          font-size: 12px;\n          font-weight: 500;\n          color: white;\n          z-index: 10;\n          transition: all 0.3s ease;\n        }\n        .connected { background: #4caf50; }\n        .connecting { background: #ff9800; }\n        .error { background: #f44336; }\n        .loading {\n          position: absolute;\n          top: 50%;\n          left: 50%;\n          transform: translate(-50%, -50%);\n        }\n        #fps-counter {\n          position: absolute;\n          top: 10px;\n          right: 10px;\n          padding: 4px 8px;\n          border-radius: 12px;\n          font-size: 11px;\n          font-weight: 500;\n          color: white;\n          background: rgba(0, 0, 0, 0.6);\n          z-index: 10;\n        }\n      </style>\n      <ha-card>\n        <div id="container">\n          <div id="status" class="connecting">Connecting...</div>\n          <div id="fps-counter">0 FPS</div>\n          <div id="loading" class="loading">\n            <ha-circular-progress indeterminate></ha-circular-progress>\n          </div>\n        </div>\n      </ha-card>\n    `}async init(){try{await this.loadThreeJS(),await this.connectWebSocket(),await this.loadRobot()}catch(e){console.error("Init error:",e),this.showError(e.message)}}async loadThreeJS(){return new Promise((e,t)=>{const n=this.getBasePath();if("undefined"!=typeof THREE&&THREE&&"undefined"!=typeof OrbitControls)return console.log("âœ… Three.js already loaded"),void e();console.log("ðŸ“¦ Loading Three.js from lib...");const o=document.createElement("script");o.src=`${n}lib/three.core.min.js`,o.type="module",o.onload=()=>{console.log("âœ… Three.js core loaded");const o=document.createElement("script");o.src=`${n}lib/three.js`,o.type="module",o.onload=()=>{console.log("âœ… Three.js loaded");const o=document.createElement("script");o.src=`${n}lib/OrbitControls.js`,o.type="module",o.onload=()=>{console.log("âœ… OrbitControls loaded"),e()},o.onerror=()=>{console.error("âŒ Failed to load OrbitControls"),t(new Error("Failed to load OrbitControls"))},document.head.appendChild(o)},o.onerror=()=>{console.error("âŒ Failed to load Three.js"),t(new Error("Failed to load Three.js"))},document.head.appendChild(o)},o.onerror=()=>{console.error("âŒ Failed to load Three.js core"),t(new Error("Failed to load Three.js core"))},document.head.appendChild(o)})}async connectWebSocket(){const{daemon_host:e,daemon_port:t}=this._config;let n=`ws://${e}:${t}/api/state/ws/full?frequency=20`;n+="&with_head_joints=true",n+="&with_antenna_positions=true",!1!==this._config.enable_passive_joints&&(n+="&with_passive_joints=true"),!1!==this._config.enable_head_pose&&(n+="&with_head_pose=true",n+="&use_pose_matrix=true"),console.log("ðŸ”Œ Connecting to WebSocket:",n),this._ws=new WebSocket(n),this._ws.onopen=()=>{console.log("âœ… WebSocket connected"),this._reconnectAttempts=0,this.updateStatus("connected","Connected")},this._ws.onmessage=e=>{try{const t=JSON.parse(e.data);this._processRobotData(t)}catch(e){console.error("âŒ Parse error:",e)}},this._ws.onerror=e=>{console.error("âŒ WebSocket error:",e),this.updateStatus("error","Error")},this._ws.onclose=()=>{if(console.log("ðŸ”Œ WebSocket closed"),this.updateStatus("error","Disconnected"),this._reconnectAttempts<this._maxReconnectAttempts){this._reconnectAttempts++;const e=Math.min(this._reconnectDelay*Math.pow(1.5,this._reconnectAttempts-1),3e4);console.log(`ðŸ”„ Reconnecting in ${e}ms (attempt ${this._reconnectAttempts}/${this._maxReconnectAttempts})`),this._reconnectTimeout=setTimeout(()=>{this.connectWebSocket()},e)}else console.error("âŒ Max reconnection attempts reached"),this.updateStatus("error","Connection Failed")}}_processRobotData(e){if(e.head_joints&&Array.isArray(e.head_joints)&&7===e.head_joints.length&&(this._robotState.headJoints=e.head_joints),e.head_pose){const t=Array.isArray(e.head_pose)?e.head_pose:e.head_pose.m;t&&16===t.length&&(this._robotState.headPose=t)}e.antennas_position&&Array.isArray(e.antennas_position)&&e.antennas_position.length>=2&&(this._robotState.antennas=e.antennas_position),e.passive_joints&&Array.isArray(e.passive_joints)&&e.passive_joints.length>=21&&(this._robotState.passiveJoints=e.passive_joints),this._robotState.dataVersion++,this._updateRobot()}_updateRobot(){if(this._robot&&(this._frameCount++,this._frameCount%3==0&&this._robotState.dataVersion!==this._lastDataVersion)){if(this._lastDataVersion=this._robotState.dataVersion,this._robotState.headJoints){const e=this._robotState.headJoints;this._robot.joints.yaw_body&&this._robot.setJointValue("yaw_body",e[0]),["stewart_1","stewart_2","stewart_3","stewart_4","stewart_5","stewart_6"].forEach((t,n)=>{this._robot.joints[t]&&this._robot.setJointValue(t,e[n+1])})}if(!1!==this._config.enable_passive_joints&&this._robotState.passiveJoints){const t=this._robotState.passiveJoints;for(let n=0;n<21;n++){const o=e[n];this._robot.joints[o]&&this._robot.setJointValue(o,t[n])}}if(this._robotState.antennas){const e=this._robotState.antennas;this._robot.joints.left_antenna&&this._robot.setJointValue("left_antenna",-e[1]),this._robot.joints.right_antenna&&this._robot.setJointValue("right_antenna",-e[0])}}}async loadRobot(){const e=this.getBasePath(),t=document.createElement("script");t.src=`${e}lib/URDFClasses.js`,document.head.appendChild(t),await new Promise(e=>t.onload=e);const n=document.createElement("script");n.src=`${e}lib/URDFDragControls.js`,document.head.appendChild(n),await new Promise(e=>n.onload=e);const o=document.createElement("script");o.src=`${e}lib/urdf-loader.js`,document.head.appendChild(o),await new Promise(e=>o.onload=e);const s=new window.URDFLoader;s.workingPath=`${e}assets/`,this._robot=await s.load(`${e}assets/reachy-mini.urdf`),this._scene.add(this._robot),this._initializeJoints();const i=this.shadowRoot.querySelector("#loading");i&&(i.style.display="none"),this._startAnimation()}_initializeJoints(){this._robot&&this._robot.joints&&(this._robot.joints.yaw_body&&this._robot.setJointValue("yaw_body",0),["stewart_1","stewart_2","stewart_3","stewart_4","stewart_5","stewart_6"].forEach(e=>{this._robot.joints[e]&&this._robot.setJointValue(e,0)}),e.forEach(e=>{this._robot.joints[e]&&this._robot.setJointValue(e,0)}),["left_antenna","right_antenna"].forEach(e=>{this._robot.joints[e]&&this._robot.setJointValue(e,0)}))}_startAnimation(){const e=this.shadowRoot.querySelector("#container"),t=document.createElement("canvas");e.appendChild(t),this._scene=new THREE.Scene,this._scene.background=new THREE.Color(this._config.background_color||"#f5f5f5"),this._camera=new THREE.PerspectiveCamera(50,e.clientWidth/this._config.height,.01,1e3),this._camera.position.set(.3,.3,this._config.camera_distance||.5),this._renderer=new THREE.WebGLRenderer({canvas:t,antialias:!0}),this._renderer.setSize(e.clientWidth,this._config.height),this._renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)),this._controls=new OrbitControls(this._camera,t),this._controls.enableDamping=!0,this._controls.dampingFactor=.05,this._controls.minDistance=.2,this._controls.maxDistance=1.5,this._scene.add(new THREE.AmbientLight(16777215,.6));const n=new THREE.DirectionalLight(16777215,.8);n.position.set(1,1,1),this._scene.add(n);const o=new THREE.DirectionalLight(16777215,.3);o.position.set(-1,-1,-1),this._scene.add(o),!1!==this._config.enable_grid&&this._scene.add(new THREE.GridHelper(.4,20,8947848,13421772)),this._fpsCounter={frameCount:0,lastTime:performance.now(),fps:0};const s=()=>{requestAnimationFrame(s),this._fpsCounter.frameCount++;const e=performance.now();if(e-this._fpsCounter.lastTime>=1e3){this._fpsCounter.fps=this._fpsCounter.frameCount,this._fpsCounter.frameCount=0,this._fpsCounter.lastTime=e;const t=this.shadowRoot.querySelector("#fps-counter");t&&(t.textContent=`${this._fpsCounter.fps} FPS`)}this._controls.update(),this._renderer.render(this._scene,this._camera)};s()}updateStatus(e,t){const n=this.shadowRoot.querySelector("#status");n&&(n.className=e,n.textContent=t)}showError(e){const t=this.shadowRoot.querySelector("#container");t&&(t.innerHTML=`\n          <div style="padding: 20px; color: #f44336;">Error: ${e}</div>\n        `)}getBasePath(){const e=document.getElementsByTagName("script"),t=e[e.length-1],n=t?.src||"";return n?n.substring(0,n.lastIndexOf("/")+1):"/hacsfiles/ha-reachy-mini-card/"}disconnectedCallback(){this._ws&&(this._ws.close(),this._ws=null),this._reconnectTimeout&&(clearTimeout(this._reconnectTimeout),this._reconnectTimeout=null),this._renderer&&(this._renderer.dispose(),this._renderer=null),this._scene&&(this._scene.clear(),this._scene=null)}}customElements.define("ha-reachy-mini-card",n)}()}();
//# sourceMappingURL=ha-reachy-mini-card.js.map
