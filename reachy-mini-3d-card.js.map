{"version":3,"file":"reachy-mini-3d-card.js","sources":["src/reachy-mini-3d-card.js"],"sourcesContent":["// Reachy Mini 3D Card - Direct Daemon Connection\n// Home Assistant Lovelace Custom Card\n\n// 注册 custom card\nwindow.customCards = window.customCards || [];\nwindow.customCards.push({\n  type: 'reachy-mini-3d-card',\n  name: 'Reachy Mini 3D Card',\n  description: 'Real-time 3D visualization of Reachy Mini robot',\n  documentationURL: 'https://github.com/Desmond-Dong/ha-reachy-mini-card'\n});\n\nclass ReachyMini3DCard extends HTMLElement {\n  constructor() {\n    super();\n    this.attachShadow({ mode: 'open' });\n  }\n\n  static get getConfigElement() {\n    return document.createElement('reachy-mini-3d-card-editor');\n  }\n\n  static getStubConfig() {\n    return {\n      daemon_host: 'localhost',\n      daemon_port: 3333,\n      height: 400\n    };\n  }\n\n  setConfig(config) {\n    this._config = {\n      daemon_host: 'localhost',\n      daemon_port: 3333,\n      height: 400,\n      ...config\n    };\n  }\n\n  getCardSize() {\n    return this._config.height ? this._config.height / 50 : 8;\n  }\n\n  async connectedCallback() {\n    this.render();\n    await this.init();\n  }\n\n  render() {\n    this.shadowRoot.innerHTML = `\n      <style>\n        :host { display: block; }\n        ha-card {\n          overflow: hidden;\n          border-radius: var(--ha-card-border-radius, 12px);\n          box-shadow: var(--ha-card-box-shadow, none);\n        }\n        #container {\n          position: relative;\n          width: 100%;\n          height: ${this._config.height}px;\n        }\n        #status {\n          position: absolute;\n          top: 10px;\n          left: 10px;\n          padding: 6px 12px;\n          border-radius: 20px;\n          font-size: 12px;\n          font-weight: 500;\n          color: white;\n          z-index: 10;\n        }\n        .connected { background: #4caf50; }\n        .connecting { background: #ff9800; }\n        .error { background: #f44336; }\n        .loading {\n          position: absolute;\n          top: 50%;\n          left: 50%;\n          transform: translate(-50%, -50%);\n        }\n      </style>\n      <ha-card>\n        <div id=\"container\">\n          <div id=\"status\" class=\"connecting\">Connecting...</div>\n          <div id=\"loading\" class=\"loading\">\n            <ha-circular-progress indeterminate></ha-circular-progress>\n          </div>\n        </div>\n      </ha-card>\n    `;\n  }\n\n  async init() {\n    try {\n      // 加载依赖\n      await this.loadScripts();\n\n      // 初始化 Three.js\n      this.initThreeJS();\n\n      // 连接 WebSocket\n      this.connectWebSocket();\n\n      // 加载机器人模型\n      this.loadRobot();\n\n    } catch (err) {\n      console.error('Init error:', err);\n      this.showError(err.message);\n    }\n  }\n\n  async loadScripts() {\n    const load = (src) => new Promise((resolve, reject) => {\n      if (document.querySelector(`script[src=\"${src}\"]`)) return resolve();\n      const script = document.createElement('script');\n      script.src = src;\n      script.onload = resolve;\n      script.onerror = () => reject(new Error(`Failed to load ${src}`));\n      document.head.appendChild(script);\n    });\n\n    if (!window.THREE) await load('https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js');\n    if (!window.THREE.OrbitControls) {\n      await load('https://unpkg.com/three@0.160.0/examples/js/controls/OrbitControls.js');\n    }\n    if (!window.THREE.STLLoader) {\n      await load('https://unpkg.com/three@0.160.0/examples/js/loaders/STLLoader.js');\n    }\n  }\n\n  initThreeJS() {\n    const container = this.shadowRoot.querySelector('#container');\n    const canvas = document.createElement('canvas');\n    container.appendChild(canvas);\n\n    // 场景\n    this._scene = new THREE.Scene();\n    this._scene.background = new THREE.Color(0xf5f5f5);\n\n    // 相机\n    this._camera = new THREE.PerspectiveCamera(50, container.clientWidth / this._config.height, 0.01, 1000);\n    this._camera.position.set(0.3, 0.3, 0.5);\n\n    // 渲染器\n    this._renderer = new THREE.WebGLRenderer({ canvas, antialias: true });\n    this._renderer.setSize(container.clientWidth, this._config.height);\n    this._renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));\n\n    // 控制器\n    this._controls = new THREE.OrbitControls(this._camera, canvas);\n    this._controls.enableDamping = true;\n    this._controls.minDistance = 0.2;\n    this._controls.maxDistance = 1.0;\n\n    // 灯光\n    this._scene.add(new THREE.AmbientLight(0xffffff, 0.6));\n    const light = new THREE.DirectionalLight(0xffffff, 0.8);\n    light.position.set(1, 1, 1);\n    this._scene.add(light);\n\n    // 地面网格\n    this._scene.add(new THREE.GridHelper(0.4, 20, 0x888888, 0xcccccc));\n\n    // 动画循环\n    const animate = () => {\n      requestAnimationFrame(animate);\n      this._controls.update();\n      this._renderer.render(this._scene, this._camera);\n    };\n    animate();\n  }\n\n  async loadRobot() {\n    const basePath = this.getBasePath();\n    const { default: URDFLoader } = await import(`${basePath}lib/urdf-loader.js`);\n\n    const loader = new URDFLoader();\n    loader.workingPath = `${basePath}assets/`;\n\n    this._robot = await loader.load(`${basePath}assets/reachy-mini.urdf`);\n    this._scene.add(this._robot);\n\n    // 隐藏加载动画\n    const loading = this.shadowRoot.querySelector('#loading');\n    if (loading) loading.style.display = 'none';\n  }\n\n  getBasePath() {\n    const scripts = document.getElementsByTagName('script');\n    const src = scripts[scripts.length - 1]?.src || '';\n    return src ? src.substring(0, src.lastIndexOf('/') + 1) : '/hacsfiles/reachy-mini-3d-card/';\n  }\n\n  connectWebSocket() {\n    const { daemon_host, daemon_port } = this._config;\n    const url = `ws://${daemon_host}:${daemon_port}/api/state/ws/full?frequency=20&with_head_joints=true&with_antenna_positions=true`;\n\n    this._ws = new WebSocket(url);\n\n    this._ws.onopen = () => {\n      this.updateStatus('connected', 'Connected');\n    };\n\n    this._ws.onmessage = (e) => {\n      try {\n        const data = JSON.parse(e.data);\n        this.updateRobot(data);\n      } catch (err) {\n        console.error('Parse error:', err);\n      }\n    };\n\n    this._ws.onerror = () => this.updateStatus('error', 'Error');\n    this._ws.onclose = () => {\n      this.updateStatus('error', 'Disconnected');\n      setTimeout(() => this.connectWebSocket(), 3000);\n    };\n  }\n\n  updateRobot(data) {\n    if (!this._robot) return;\n\n    if (data.head_joints?.length === 7) {\n      const j = data.head_joints;\n      this._robot.setJointValue('yaw_body', j[0]);\n      this._robot.setJointValue('stewart_1', j[1]);\n      this._robot.setJointValue('stewart_2', j[2]);\n      this._robot.setJointValue('stewart_3', j[3]);\n      this._robot.setJointValue('stewart_4', j[4]);\n      this._robot.setJointValue('stewart_5', j[5]);\n      this._robot.setJointValue('stewart_6', j[6]);\n    }\n\n    if (data.antennas_position?.length === 2) {\n      this._robot.setJointValue('left_antenna', -data.antennas_position[0]);\n      this._robot.setJointValue('right_antenna', -data.antennas_position[1]);\n    }\n  }\n\n  updateStatus(state, msg) {\n    const el = this.shadowRoot.querySelector('#status');\n    if (el) {\n      el.className = state;\n      el.textContent = msg;\n    }\n  }\n\n  showError(msg) {\n    this.shadowRoot.querySelector('#container').innerHTML = `\n      <div style=\"padding: 20px; color: #f44336;\">Error: ${msg}</div>\n    `;\n  }\n\n  disconnectedCallback() {\n    if (this._ws) this._ws.close();\n    if (this._renderer) this._renderer.dispose();\n  }\n}\n\ncustomElements.define('reachy-mini-3d-card', ReachyMini3DCard);\n\n// 图形化配置编辑器\nclass ReachyMini3DCardEditor extends HTMLElement {\n  constructor() {\n    super();\n    this.attachShadow({ mode: 'open' });\n  }\n\n  setConfig(config) {\n    this._config = config;\n    this.render();\n  }\n\n  render() {\n    const config = this._config || {};\n\n    this.shadowRoot.innerHTML = `\n      <style>\n        :host { display: block; }\n        .form-row {\n          display: flex;\n          flex-direction: column;\n          margin-bottom: 12px;\n        }\n        label {\n          font-size: 14px;\n          font-weight: 500;\n          margin-bottom: 4px;\n          color: var(--primary-text-color);\n        }\n        input {\n          width: 100%;\n          padding: 8px;\n          border: 1px solid var(--primary-color);\n          border-radius: 4px;\n          background: var(--card-background-color);\n          color: var(--primary-text-color);\n          box-sizing: border-box;\n        }\n        input:focus {\n          outline: none;\n          border-color: var(--accent-color);\n        }\n        .hint {\n          font-size: 12px;\n          color: var(--secondary-text-color);\n          margin-top: 4px;\n        }\n      </style>\n      <div class=\"form-row\">\n        <label for=\"host\">Daemon Host</label>\n        <input\n          id=\"host\"\n          type=\"text\"\n          value=\"${config.daemon_host || 'localhost'}\"\n          placeholder=\"localhost or IP address\"\n        />\n        <div class=\"hint\">Reachy Mini daemon hostname or IP address</div>\n      </div>\n      <div class=\"form-row\">\n        <label for=\"port\">Daemon Port</label>\n        <input\n          id=\"port\"\n          type=\"number\"\n          value=\"${config.daemon_port || 3333}\"\n          placeholder=\"3333\"\n        />\n        <div class=\"hint\">WebSocket port (default: 3333)</div>\n      </div>\n      <div class=\"form-row\">\n        <label for=\"height\">Card Height (px)</label>\n        <input\n          id=\"height\"\n          type=\"number\"\n          value=\"${config.height || 400}\"\n          placeholder=\"400\"\n        />\n        <div class=\"hint\">Height of the card in pixels</div>\n      </div>\n    `;\n\n    // 监听输入变化\n    this.shadowRoot.getElementById('host').addEventListener('change', (e) => {\n      this._config = { ...this._config, daemon_host: e.target.value };\n      this.dispatchConfig();\n    });\n\n    this.shadowRoot.getElementById('port').addEventListener('change', (e) => {\n      this._config = { ...this._config, daemon_port: parseInt(e.target.value) };\n      this.dispatchConfig();\n    });\n\n    this.shadowRoot.getElementById('height').addEventListener('change', (e) => {\n      this._config = { ...this._config, height: parseInt(e.target.value) };\n      this.dispatchConfig();\n    });\n  }\n\n  dispatchConfig() {\n    const event = new CustomEvent('config-changed', {\n      detail: { config: this._config },\n      bubbles: true,\n      composed: true\n    });\n    this.dispatchEvent(event);\n  }\n}\n\ncustomElements.define('reachy-mini-3d-card-editor', ReachyMini3DCardEditor);\n"],"names":["window","customCards","push","type","name","description","documentationURL","ReachyMini3DCard","HTMLElement","constructor","super","this","attachShadow","mode","getConfigElement","document","createElement","getStubConfig","daemon_host","daemon_port","height","setConfig","config","_config","getCardSize","connectedCallback","render","init","shadowRoot","innerHTML","loadScripts","initThreeJS","connectWebSocket","loadRobot","err","console","error","showError","message","load","src","Promise","resolve","reject","querySelector","script","onload","onerror","Error","head","appendChild","THREE","OrbitControls","STLLoader","container","canvas","_scene","Scene","background","Color","_camera","PerspectiveCamera","clientWidth","position","set","_renderer","WebGLRenderer","antialias","setSize","setPixelRatio","Math","min","devicePixelRatio","_controls","enableDamping","minDistance","maxDistance","add","AmbientLight","light","DirectionalLight","GridHelper","animate","requestAnimationFrame","update","basePath","getBasePath","default","URDFLoader","import","loader","workingPath","_robot","loading","style","display","scripts","getElementsByTagName","length","substring","lastIndexOf","url","_ws","WebSocket","onopen","updateStatus","onmessage","e","data","JSON","parse","updateRobot","onclose","setTimeout","head_joints","j","setJointValue","antennas_position","state","msg","el","className","textContent","disconnectedCallback","close","dispose","customElements","define","ReachyMini3DCardEditor","getElementById","addEventListener","target","value","dispatchConfig","parseInt","event","CustomEvent","detail","bubbles","composed","dispatchEvent"],"mappings":"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"}